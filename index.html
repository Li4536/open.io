<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>加气站计量工资计算系统</title>
    <link href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-100-M/font-awesome/6.0.0/css/all.min.css"  rel="stylesheet">
    <link href="https://s2.ssl.qhres2.com/static/56662140ef7d5d03.css"  rel="stylesheet">
    <script src="https://s2.ssl.qhres2.com/!2dd0bbf7/echats.js"></script> 
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script> 
    <style>
        :root {
            --primary: #3498db;
            --secondary: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --dark: #34495e;
            --light: #ecf0f1;
            --border-radius: 0.375rem;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #3498db, #2c3e50);
            color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }
        
        .header::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, #2ecc71, #3498db);
        }
        
        .card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 30px;
            transition: var(--transition);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--dark);
            border-bottom: 2px solid var(--light);
            padding-bottom: 10px;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            border-radius: var(--border-radius);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            border: none;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #27ae60;
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn i {
            margin-right: 8px;
        }
        
        .table-responsive {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: var(--dark);
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }
        
        input:focus, select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .alert {
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .badge-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .badge-secondary {
            background-color: var(--secondary);
            color: white;
        }
        
        .badge-warning {
            background-color: var(--warning);
            color: white;
        }
        
        .badge-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: var(--transition);
        }
        
        .tab.active  {
            border-bottom-color: var(--primary);
            color: var(--primary);
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active  {
            display: block;
        }
        
        .file-upload {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        
        .file-upload-input {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-upload-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px;
            border: 2px dashed #ddd;
            border-radius: var(--border-radius);
            background-color: #f8f9fa;
            text-align: center;
            transition: var(--transition);
        }
        
        .file-upload-label:hover {
            border-color: var(--primary);
            background-color: #eaf2f8;
        }
        
        .file-upload-label i {
            font-size: 24px;
            margin-right: 10px;
            color: var(--primary);
        }
        
        .progress {
            height: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background-color: var(--primary);
            width: 0;
            transition: width 0.3s ease;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #f5f7fa, #e4e7eb);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
        }
        
        .summary-title {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .summary-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--dark);
        }
        
        @media (max-width: 768px) {
            .header {
                padding: 15px;
            }
            
            th, td {
                padding: 8px 10px;
            }
        }
        
        /* 动画效果 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.5s ease forwards;
        }
        
        .delay-1 { animation-delay: 0.1s; }
        .delay-2 { animation-delay: 0.2s; }
        .delay-3 { animation-delay: 0.3s; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header animate-fade-in">
            <h1 class="text-3xl font-bold">加气站计量工资计算系统</h1>
            <p class="mt-2">精准计量 · 公平分配 · 激励增效</p>
        </div>
        
        <div class="tabs animate-fade-in delay-1">
            <div class="tab active" data-tab="data-entry">数据录入</div>
            <div class="tab" data-tab="calculation">工资计算</div>
            <div class="tab" data-tab="results">计算结果</div>
        </div>
        
        <div class="tab-content active animate-fade-in delay-1" id="data-entry">
            <div class="card">
                <div class="card-title">批量导入数据</div>
                
                <div class="alert alert-success mb-4">
                    <i class="fas fa-info-circle mr-2"></i> 支持Excel文件批量导入员工数据，请先下载模板文件填写数据 
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <a href="#" id="download-template" class="btn btn-secondary">
                            <i class="fas fa-file-download"></i> 下载导入模板 
                        </a>
                    </div>
                    <div>
                        <div class="file-upload">
                            <input type="file" id="file-input" class="file-upload-input" accept=".xlsx, .xls">
                            <label for="file-input" class="file-upload-label">
                                <i class="fas fa-file-upload"></i>
                                <span>点击或拖拽Excel文件到此处</span>
                            </label>
                        </div>
                        <div class="progress mt-2" id="upload-progress" style="display: none;">
                            <div class="progress-bar" id="progress-bar"></div>
                        </div>
                    </div>
                </div>
                
                <div id="import-preview" style="display: none;">
                    <div class="card-title">导入数据预览</div>
                    <div class="table-responsive">
                        <table id="preview-table">
                            <thead>
                                <tr>
                                    <th>姓名</th>
                                    <th>加气站</th>
                                    <th>职位</th>
                                    <th>加气量(kg)</th>
                                    <th>卸车数</th>
                                    <th>绩效系数</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <button id="confirm-import" class="btn btn-primary mt-3">
                        <i class="fas fa-check"></i> 确认导入 
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">手动录入数据</div>
                
                <form id="employee-form">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-group">
                            <label for="name">员工姓名</label>
                            <input type="text" id="name" required>
                        </div>
                        <div class="form-group">
                            <label for="station">所属加气站</label>
                            <select id="station" required>
                                <option value="">请选择加气站</option>
                                <option value="加气站A">加气站A</option>
                                <option value="加气站B">加气站B</option>
                                <option value="加气站C">加气站C</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="position">职位</label>
                            <select id="position" required>
                                <option value="">请选择职位</option>
                                <option value="加气员">加气员</option>
                                <option value="站长">站长</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="gas-amount">加气量(kg)</label>
                            <input type="number" id="gas-amount" min="0" step="1" value="0">
                        </div>
                        <div class="form-group">
                            <label for="unload-count">卸车数</label>
                            <input type="number" id="unload-count" min="0" step="1" value="0">
                        </div>
                        <div class="form-group">
                            <label for="performance">绩效系数</label>
                            <select id="performance">
                                <option value="1">1类 - 无违规</option>
                                <option value="0.95">2类 - 违规1次(下浮5%)</option>
                                <option value="0.85">3类 - 违规2次(下浮15%)</option>
                                <option value="0.7">4类 - 违规3次(下浮30%)</option>
                                <option value="0">5类 - 违规4次(下浮100%)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i> 添加员工 
                        </button>
                        <button type="button" id="clear-form" class="btn btn-danger ml-2">
                            <i class="fas fa-trash"></i> 清空表单 
                        </button>
                    </div>
                </form>
            </div>
            
            <div class="card">
                <div class="card-title">已录入员工列表</div>
                
                <div class="table-responsive">
                    <table id="employee-table">
                        <thead>
                            <tr>
                                <th>姓名</th>
                                <th>加气站</th>
                                <th>职位</th>
                                <th>加气量(kg)</th>
                                <th>卸车数</th>
                                <th>绩效系数</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                
                <div class="mt-4">
                    <button id="calculate-btn" class="btn btn-secondary">
                        <i class="fas fa-calculator"></i> 计算工资 
                    </button>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="calculation">
            <div class="card animate-fade-in delay-2">
                <div class="card-title">工资池分配</div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="summary-card">
                        <div class="summary-title">加气计量池</div>
                        <div class="summary-value">¥12,175</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-title">卸车计量池</div>
                        <div class="summary-value">¥3,200</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-title">站长计量池</div>
                        <div class="summary-value">¥4,500</div>
                    </div>
                </div>
                
                <div class="alert alert-success mb-4">
                    <i class="fas fa-info-circle mr-2"></i> 系统将根据录入数据自动计算各加气站的B系数和员工工资 
                </div>
                
                <div class="table-responsive">
                    <table id="station-summary">
                        <thead>
                            <tr>
                                <th>加气站</th>
                                <th>总加气量(kg)</th>
                                <th>总卸车数</th>
                                <th>B系数</th>
                                <th>加气员人数</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="results">
            <div class="card animate-fade-in delay-3">
                <div class="card-title">工资计算结果</div>
                
                <div class="alert alert-success mb-4">
                    <i class="fas fa-info-circle mr-2"></i> 计算结果已生成，总计发放工资总额为¥18,975 
                </div>
                
                <div class="table-responsive">
                    <table id="result-table">
                        <thead>
                            <tr>
                                <th>姓名</th>
                                <th>加气站</th>
                                <th>职位</th>
                                <th>加气工资</th>
                                <th>卸车工资</th>
                                <th>站长工资</th>
                                <th>绩效调整</th>
                                <th>应发工资</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                
                <div class="mt-4">
                    <button id="download-results" class="btn btn-secondary">
                        <i class="fas fa-file-excel"></i> 下载工资表 
                    </button>
                    <button id="back-to-entry" class="btn btn-primary ml-2">
                        <i class="fas fa-arrow-left"></i> 返回录入 
                    </button>
                </div>
            </div>
        </div>
    </div>
 
    <script>
        // 全局变量 
        let employees = [];
        let calculationResults = [];
        let stationData = {};
        
        // DOM元素 
        const tabs = document.querySelectorAll('.tab'); 
        const tabContents = document.querySelectorAll('.tab-content'); 
        const employeeForm = document.getElementById('employee-form'); 
        const employeeTable = document.getElementById('employee-table').getElementsByTagName('tbody')[0]; 
        const calculateBtn = document.getElementById('calculate-btn'); 
        const stationSummary = document.getElementById('station-summary').getElementsByTagName('tbody')[0]; 
        const resultTable = document.getElementById('result-table').getElementsByTagName('tbody')[0]; 
        const downloadTemplate = document.getElementById('download-template'); 
        const fileInput = document.getElementById('file-input'); 
        const previewTable = document.getElementById('preview-table').getElementsByTagName('tbody')[0]; 
        const importPreview = document.getElementById('import-preview'); 
        const confirmImport = document.getElementById('confirm-import'); 
        const uploadProgress = document.getElementById('upload-progress'); 
        const progressBar = document.getElementById('progress-bar'); 
        const downloadResults = document.getElementById('download-results'); 
        const backToEntry = document.getElementById('back-to-entry'); 
        const clearForm = document.getElementById('clear-form'); 
        
        // 初始化 
        document.addEventListener('DOMContentLoaded',  function() {
            // 加载示例数据 
            loadSampleData();
            
            // 绑定事件 
            bindEvents();
        });
        
        // 加载示例数据 
        function loadSampleData() {
            // 这里可以加载一些示例数据用于演示 
            employees = [
                { name: '张三', station: '加气站A', position: '加气员', gasAmount: 15000, unloadCount: 8, performance: 1 },
                { name: '李四', station: '加气站A', position: '加气员', gasAmount: 12000, unloadCount: 5, performance: 0.95 },
                { name: '王五', station: '加气站B', position: '站长', gasAmount: 0, unloadCount: 0, performance: 1 },
                { name: '赵六', station: '加气站B', position: '加气员', gasAmount: 18000, unloadCount: 10, performance: 1 },
                { name: '钱七', station: '加气站C', position: '站长', gasAmount: 0, unloadCount: 0, performance: 1 },
                { name: '孙八', station: '加气站C', position: '加气员', gasAmount: 20000, unloadCount: 12, performance: 0.85 }
            ];
            
            renderEmployeeTable();
        }
        
        // 绑定事件 
        function bindEvents() {
            // 标签页切换 
            tabs.forEach(tab  => {
                tab.addEventListener('click',  function() {
                    const tabId = this.getAttribute('data-tab'); 
                    
                    // 更新活动标签 
                    tabs.forEach(t  => t.classList.remove('active')); 
                    this.classList.add('active'); 
                    
                    // 更新活动内容 
                    tabContents.forEach(content  => {
                        content.classList.remove('active'); 
                        if (content.id  === tabId) {
                            content.classList.add('active'); 
                        }
                    });
                });
            });
            
            // 添加员工 
            employeeForm.addEventListener('submit',  function(e) {
                e.preventDefault(); 
                
                const employee = {
                    name: document.getElementById('name').value, 
                    station: document.getElementById('station').value, 
                    position: document.getElementById('position').value, 
                    gasAmount: parseFloat(document.getElementById('gas-amount').value)  || 0,
                    unloadCount: parseFloat(document.getElementById('unload-count').value)  || 0,
                    performance: parseFloat(document.getElementById('performance').value) 
                };
                
                employees.push(employee); 
                renderEmployeeTable();
                this.reset(); 
            });
            
            // 清空表单 
            clearForm.addEventListener('click',  function() {
                employeeForm.reset(); 
            });
            
            // 计算工资 
            calculateBtn.addEventListener('click',  function() {
                calculateWages();
                
                // 切换到结果标签页 
                document.querySelector('.tab[data-tab="results"]').click(); 
            });
            
            // 下载模板 
            downloadTemplate.addEventListener('click',  function(e) {
                e.preventDefault(); 
                downloadExcelTemplate();
            });
            
            // 文件导入 
            fileInput.addEventListener('change',  function(e) {
                handleFileImport(e.target.files[0]); 
            });
            
            // 确认导入 
            confirmImport.addEventListener('click',  function() {
                confirmDataImport();
            });
            
            // 拖放功能 
            const dropArea = document.querySelector('.file-upload-label'); 
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName,  preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault(); 
                e.stopPropagation(); 
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName,  highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName,  unhighlight, false);
            });
            
            function highlight() {
                dropArea.style.borderColor  = '#3498db';
                dropArea.style.backgroundColor  = '#eaf2f8';
            }
            
            function unhighlight() {
                dropArea.style.borderColor  = '#ddd';
                dropArea.style.backgroundColor  = '#f8f9fa';
            }
            
            dropArea.addEventListener('drop',  function(e) {
                const dt = e.dataTransfer; 
                const files = dt.files; 
                
                if (files.length  > 0) {
                    handleFileImport(files[0]);
                }
            });
            
            // 下载结果 
            downloadResults.addEventListener('click',  function() {
                downloadCalculationResults();
            });
            
            // 返回录入 
            backToEntry.addEventListener('click',  function() {
                document.querySelector('.tab[data-tab="data-entry"]').click(); 
            });
        }
        
        // 渲染员工表格 
        function renderEmployeeTable() {
            employeeTable.innerHTML  = '';
            
            employees.forEach((employee,  index) => {
                const row = employeeTable.insertRow(); 
                
                row.insertCell().textContent  = employee.name; 
                row.insertCell().textContent  = employee.station; 
                row.insertCell().textContent  = employee.position; 
                row.insertCell().textContent  = employee.gasAmount.toLocaleString(); 
                row.insertCell().textContent  = employee.unloadCount; 
                
                const performanceCell = row.insertCell(); 
                let performanceText = '';
                let badgeClass = '';
                
                switch(employee.performance)  {
                    case 1: 
                        performanceText = '1类 - 无违规';
                        badgeClass = 'badge-secondary';
                        break;
                    case 0.95: 
                        performanceText = '2类 - 违规1次';
                        badgeClass = 'badge-primary';
                        break;
                    case 0.85: 
                        performanceText = '3类 - 违规2次';
                        badgeClass = 'badge-warning';
                        break;
                    case 0.7: 
                        performanceText = '4类 - 违规3次';
                        badgeClass = 'badge-warning';
                        break;
                    case 0: 
                        performanceText = '5类 - 违规4次';
                        badgeClass = 'badge-danger';
                        break;
                }
                
                const badge = document.createElement('span'); 
                badge.className  = `badge ${badgeClass}`;
                badge.textContent  = performanceText;
                performanceCell.appendChild(badge); 
                
                const actionCell = row.insertCell(); 
                const editBtn = document.createElement('button'); 
                editBtn.className  = 'btn btn-primary btn-sm';
                editBtn.innerHTML  = '<i class="fas fa-edit"></i>';
                editBtn.title  = '编辑';
                editBtn.addEventListener('click',  () => editEmployee(index));
                
                const deleteBtn = document.createElement('button'); 
                deleteBtn.className  = 'btn btn-danger btn-sm ml-1';
                deleteBtn.innerHTML  = '<i class="fas fa-trash"></i>';
                deleteBtn.title  = '删除';
                deleteBtn.addEventListener('click',  () => deleteEmployee(index));
                
                actionCell.appendChild(editBtn); 
                actionCell.appendChild(deleteBtn); 
            });
        }
        
        // 编辑员工 
        function editEmployee(index) {
            const employee = employees[index];
            
            document.getElementById('name').value  = employee.name; 
            document.getElementById('station').value  = employee.station; 
            document.getElementById('position').value  = employee.position; 
            document.getElementById('gas-amount').value  = employee.gasAmount; 
            document.getElementById('unload-count').value  = employee.unloadCount; 
            document.getElementById('performance').value  = employee.performance; 
            
            // 删除原记录 
            employees.splice(index,  1);
            renderEmployeeTable();
        }
        
        // 删除员工 
        function deleteEmployee(index) {
            if (confirm('确定要删除此员工记录吗？')) {
                employees.splice(index,  1);
                renderEmployeeTable();
            }
        }
        
        // 计算工资 
        function calculateWages() {
            // 初始化加气站数据 
            stationData = {
                '加气站A': { totalGas: 0, totalUnload: 0, bCoefficient: 1, employeeCount: 0 },
                '加气站B': { totalGas: 0, totalUnload: 0, bCoefficient: 1, employeeCount: 0 },
                '加气站C': { totalGas: 0, totalUnload: 0, bCoefficient: 1, employeeCount: 0 }
            };
            
            // 计算各站总加气量和卸车数 
            employees.forEach(employee  => {
                if (employee.position  === '加气员') {
                    stationData[employee.station].totalGas += employee.gasAmount; 
                    stationData[employee.station].totalUnload += employee.unloadCount; 
                    stationData[employee.station].employeeCount++;
                }
            });
            
            // 计算各站B系数 
            const totalGasAll = Object.values(stationData).reduce((sum,  station) => sum + station.totalGas,  0);
            const avgGasPerStation = totalGasAll / 3;
            
            Object.keys(stationData).forEach(station  => {
                const stationInfo = stationData[station];
                const deviation = (stationInfo.totalGas  - avgGasPerStation) / avgGasPerStation;
                stationInfo.bCoefficient = 1 + deviation * 0.5; // B系数 = 1 + (偏差 * 0.5)
            });
            
            // 渲染加气站汇总 
            renderStationSummary();
            
            // 计算员工工资 
            calculationResults = [];
            
            // 工资池 
            const gasPool = 12175; // 加气计量池 
            const unloadPool = 3200; // 卸车计量池 
            const managerPool = 3600; // 站长计量池 
            
            // 计算加气工资单价 
            const totalWeightedGas = employees 
                .filter(e => e.position  === '加气员')
                .reduce((sum, e) => sum + e.gasAmount  * stationData[e.station].bCoefficient * e.performance,  0);
            
            const gasUnitPrice = totalWeightedGas > 0 ? gasPool / totalWeightedGas : 0;
            
            // 计算卸车工资单价 
            const totalWeightedUnload = employees 
                .filter(e => e.position  === '加气员')
                .reduce((sum, e) => sum + e.unloadCount  * stationData[e.station].bCoefficient * e.performance,  0);
            
            const unloadUnitPrice = totalWeightedUnload > 0 ? unloadPool / totalWeightedUnload : 0;
            
            // 站长人数 
            const managerCount = employees.filter(e  => e.position  === '站长').length;
            const managerSalary = managerCount > 0 ? managerPool / managerCount : 0;
            
            // 计算每个员工的工资 
            employees.forEach(employee  => {
                let gasSalary = 0;
                let unloadSalary = 0;
                let managerSalaryForEmployee = 0;
                
                if (employee.position  === '加气员') {
                    gasSalary = employee.gasAmount  * stationData[employee.station].bCoefficient * gasUnitPrice * employee.performance; 
                    unloadSalary = employee.unloadCount  * stationData[employee.station].bCoefficient * unloadUnitPrice * employee.performance; 
                } else if (employee.position  === '站长') {
                    managerSalaryForEmployee = managerSalary * stationData[employee.station].bCoefficient;
                }
                
                const totalSalary = gasSalary + unloadSalary + managerSalaryForEmployee;
                
                calculationResults.push({ 
                    name: employee.name, 
                    station: employee.station, 
                    position: employee.position, 
                    gasSalary: gasSalary,
                    unloadSalary: unloadSalary,
                    managerSalary: managerSalaryForEmployee,
                    performance: employee.performance, 
                    totalSalary: totalSalary 
                });
            });
            
            // 渲染结果表格 
            renderResultTable();
        }
        
        // 渲染加气站汇总 
        function renderStationSummary() {
            stationSummary.innerHTML  = '';
            
            Object.keys(stationData).forEach(station  => {
                const row = stationSummary.insertRow(); 
                
                row.insertCell().textContent  = station;
                row.insertCell().textContent  = stationData[station].totalGas.toLocaleString(); 
                row.insertCell().textContent  = stationData[station].totalUnload;
                row.insertCell().textContent  = stationData[station].bCoefficient.toFixed(4); 
                row.insertCell().textContent  = stationData[station].employeeCount;
            });
        }
        
        // 渲染结果表格 
        function renderResultTable() {
            resultTable.innerHTML  = '';
            
            calculationResults.forEach(result  => {
                const row = resultTable.insertRow(); 
                
                row.insertCell().textContent  = result.name; 
                row.insertCell().textContent  = result.station; 
                row.insertCell().textContent  = result.position; 
                row.insertCell().textContent  = '¥' + result.gasSalary.toFixed(2); 
                row.insertCell().textContent  = '¥' + result.unloadSalary.toFixed(2); 
                row.insertCell().textContent  = '¥' + result.managerSalary.toFixed(2); 
                
                const performanceCell = row.insertCell(); 
                let performanceText = '';
                let badgeClass = '';
                
                switch(result.performance)  {
                    case 1: 
                        performanceText = '1类 - 无违规';
                        badgeClass = 'badge-secondary';
                        break;
                    case 0.95: 
                        performanceText = '2类 - 违规1次';
                        badgeClass = 'badge-primary';
                        break;
                    case 0.85: 
                        performanceText = '3类 - 违规2次';
                        badgeClass = 'badge-warning';
                        break;
                    case 0.7: 
                        performanceText = '4类 - 违规3次';
                        badgeClass = 'badge-warning';
                        break;
                    case 0: 
                        performanceText = '5类 - 违规4次';
                        badgeClass = 'badge-danger';
                        break;
                }
                
                const badge = document.createElement('span'); 
                badge.className  = `badge ${badgeClass}`;
                badge.textContent  = performanceText;
                performanceCell.appendChild(badge); 
                
                row.insertCell().textContent  = '¥' + result.totalSalary.toFixed(2); 
            });
            
            // 添加总计行 
            const totalRow = resultTable.insertRow(); 
            totalRow.className  = 'font-bold';
            
            totalRow.insertCell().textContent  = '总计';
            totalRow.insertCell().colSpan  = 6;
            totalRow.insertCell().textContent  = '¥' + calculationResults.reduce((sum,  r) => sum + r.totalSalary,  0).toFixed(2);
        }
        
        // 下载Excel模板 
        function downloadExcelTemplate() {
            const templateData = [
                ['姓名', '加气站', '职位', '加气量(kg)', '卸车数', '绩效系数'],
                ['张三', '加气站A', '加气员', 15000, 8, 1],
                ['李四', '加气站A', '加气员', 12000, 5, 0.95],
                ['王五', '加气站B', '站长', 0, 0, 1],
                ['', '', '', '', '', ''],
                ['说明：', '', '', '', '', ''],
                ['1. 加气站可选值：加气站A、加气站B、加气站C', '', '', '', '', ''],
                ['2. 职位可选值：加气员、站长', '', '', '', '', ''],
                ['3. 绩效系数可选值：1(无违规)、0.95(违规1次)、0.85(违规2次)、0.7(违规3次)、0(违规4次)', '', '', '', '', '']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(templateData); 
            const wb = XLSX.utils.book_new(); 
            XLSX.utils.book_append_sheet(wb,  ws, "员工数据模板");
            
            // 设置列宽 
            ws['!cols'] = [
                { width: 15 }, // 姓名 
                { width: 15 }, // 加气站 
                { width: 15 }, // 职位 
                { width: 15 }, // 加气量 
                { width: 15 }, // 卸车数 
                { width: 15 }  // 绩效系数 
            ];
            
            XLSX.writeFile(wb,  "加气站员工数据模板.xlsx");
        }
        
        // 处理文件导入 
        function handleFileImport(file) {
            if (!file) return;
            
            const fileName = file.name.toLowerCase(); 
            if (!fileName.endsWith('.xlsx')  && !fileName.endsWith('.xls'))  {
                alert('请上传Excel文件(.xlsx或.xls格式)');
                return;
            }
            
            // 显示上传进度 
            uploadProgress.style.display  = 'block';
            progressBar.style.width  = '30%';
            
            const reader = new FileReader();
            
            reader.onload  = function(e) {
                try {
                    const data = new Uint8Array(e.target.result); 
                    const workbook = XLSX.read(data,  { type: 'array' });
                    
                    // 假设第一个工作表包含数据 
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet,  { header: 1 });
                    
                    // 验证数据格式 
                    if (jsonData.length  < 1 || 
                        jsonData[0][0] !== '姓名' || 
                        jsonData[0][1] !== '加气站' || 
                        jsonData[0][2] !== '职位') {
                        throw new Error('文件格式不正确，请使用下载的模板填写数据');
                    }
                    
                    // 更新进度 
                    progressBar.style.width  = '70%';
                    
                    // 解析数据 
                    const importedEmployees = [];
                    
                    for (let i = 1; i < jsonData.length;  i++) {
                        const row = jsonData[i];
                        if (row.length  < 6 || !row[0]) continue; // 跳过空行 
                        
                        importedEmployees.push({ 
                            name: row[0],
                            station: row[1],
                            position: row[2],
                            gasAmount: parseFloat(row[3]) || 0,
                            unloadCount: parseFloat(row[4]) || 0,
                            performance: parseFloat(row[5]) || 1 
                        });
                    }
                    
                    // 更新进度 
                    progressBar.style.width  = '90%';
                    
                    // 显示预览 
                    previewTable.innerHTML  = '';
                    importedEmployees.forEach(emp  => {
                        const row = previewTable.insertRow(); 
                        
                        row.insertCell().textContent  = emp.name; 
                        row.insertCell().textContent  = emp.station; 
                        row.insertCell().textContent  = emp.position; 
                        row.insertCell().textContent  = emp.gasAmount.toLocaleString(); 
                        row.insertCell().textContent  = emp.unloadCount; 
                        
                        const performanceCell = row.insertCell(); 
                        let performanceText = '';
                        let badgeClass = '';
                        
                        switch(emp.performance)  {
                            case 1: 
                                performanceText = '1类';
                                badgeClass = 'badge-secondary';
                                break;
                            case 0.95: 
                                performanceText = '2类';
                                badgeClass = 'badge-primary';
                                break;
                            case 0.85: 
                                performanceText = '3类';
                                badgeClass = 'badge-warning';
                                break;
                            case 0.7: 
                                performanceText = '4类';
                                badgeClass = 'badge-warning';
                                break;
                            case 0: 
                                performanceText = '5类';
                                badgeClass = 'badge-danger';
                                break;
                            default:
                                performanceText = '1类';
                                badgeClass = 'badge-secondary';
                        }
                        
                        const badge = document.createElement('span'); 
                        badge.className  = `badge ${badgeClass}`;
                        badge.textContent  = performanceText;
                        performanceCell.appendChild(badge); 
                    });
                    
                    // 完成进度 
                    progressBar.style.width  = '100%';
                    setTimeout(() => {
                        uploadProgress.style.display  = 'none';
                        importPreview.style.display  = 'block';
                    }, 500);
                    
                    // 存储导入的数据 
                    window.tempImportedEmployees  = importedEmployees;
                    
                } catch (error) {
                    uploadProgress.style.display  = 'none';
                    alert('导入失败: ' + error.message); 
                    console.error(error); 
                }
            };
            
            reader.onerror  = function() {
                uploadProgress.style.display  = 'none';
                alert('文件读取失败');
            };
            
            reader.readAsArrayBuffer(file); 
        }
        
        // 确认导入数据 
        function confirmDataImport() {
            if (window.tempImportedEmployees  && window.tempImportedEmployees.length  > 0) {
                employees = employees.concat(window.tempImportedEmployees); 
                renderEmployeeTable();
                
                // 重置导入状态 
                importPreview.style.display  = 'none';
                fileInput.value  = '';
                delete window.tempImportedEmployees; 
                
                alert('成功导入 ' + window.tempImportedEmployees.length  + ' 条员工记录');
            }
        }
        
        // 下载计算结果 
        function downloadCalculationResults() {
            if (calculationResults.length  === 0) {
                alert('请先计算工资结果');
                return;
            }
            
            // 准备数据 
            const data = [
                ['姓名', '加气站', '职位', '加气工资', '卸车工资', '站长工资', '绩效系数', '应发工资']
            ];
            
            calculationResults.forEach(result  => {
                data.push([ 
                    result.name, 
                    result.station, 
                    result.position, 
                    result.gasSalary.toFixed(2), 
                    result.unloadSalary.toFixed(2), 
                    result.managerSalary.toFixed(2), 
                    result.performance, 
                    result.totalSalary.toFixed(2) 
                ]);
            });
            
            // 添加总计行 
            data.push([ 
                '总计', 
                '', 
                '', 
                calculationResults.reduce((sum,  r) => sum + r.gasSalary,  0).toFixed(2),
                calculationResults.reduce((sum,  r) => sum + r.unloadSalary,  0).toFixed(2),
                calculationResults.reduce((sum,  r) => sum + r.managerSalary,  0).toFixed(2),
                '',
                calculationResults.reduce((sum,  r) => sum + r.totalSalary,  0).toFixed(2)
            ]);
            
            // 创建工作表 
            const ws = XLSX.utils.aoa_to_sheet(data); 
            const wb = XLSX.utils.book_new(); 
            XLSX.utils.book_append_sheet(wb,  ws, "工资计算结果");
            
            // 设置列宽 
            ws['!cols'] = [
                { width: 15 }, // 姓名 
                { width: 15 }, // 加气站 
                { width: 15 }, // 职位 
                { width: 15 }, // 加气工资 
                { width: 15 }, // 卸车工资 
                { width: 15 }, // 站长工资 
                { width: 15 }, // 绩效系数 
                { width: 15 }  // 应发工资 
            ];
            
            // 添加标题和说明 
            const infoData = [
                ['加气站计量工资计算表', '', '', '', '', '', '', ''],
                ['计算日期:', new Date().toLocaleDateString(), '', '', '', '', '', ''],
                ['', '', '', '', '', '', '', ''],
                ['工资池分配:', '', '', '', '', '', '', ''],
                ['加气计量池:', '¥12,175.00', '', '', '', '', '', ''],
                ['卸车计量池:', '¥3,200.00', '', '', '', '', '', ''],
                ['站长计量池:', '¥4,500.00', '', '', '', '', '', ''],
                ['总计:', '¥18,975.00', '', '', '', '', '', '']
            ];
            
            const infoWs = XLSX.utils.aoa_to_sheet(infoData); 
            XLSX.utils.book_append_sheet(wb,  infoWs, "工资池信息");
            
            // 生成文件名 
            const dateStr = new Date().toISOString().slice(0, 10);
            const fileName = `加气站工资表_${dateStr}.xlsx`;
            
            XLSX.writeFile(wb,  fileName);
        }
    </script>
</body>
</html>
